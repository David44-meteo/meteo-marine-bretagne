<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Météo Marine Bretagne - PWA</title>
    <meta name="description" content="Application de météo marine pour la navigation en Bretagne">
    <meta name="theme-color" content="#1a2980">
    
    <!-- PWA Manifest & Icons (Twemoji - fonctionne sans fichier) -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/72x72/1f30a.png">
    <link rel="apple-touch-icon" href="https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/152x152/1f30a.png">
    
    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Styles -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Service Worker -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js')
                    .then(reg => console.log('✅ SW enregistré'))
                    .catch(err => console.log('❌ SW erreur', err));
            });
        }
    </script>
</head>
<body>
    <!-- Install Prompt Flottant -->
    <button id="installButton" class="install-btn" onclick="installFromMenu()" style="display: none;">
        <i class="fas fa-download"></i> Installer l'App
    </button>

    <!-- App Container -->
    <div class="container">
        <!-- Header -->
        <header class="app-header">
            <button class="menu-btn" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </button>
            <h1><i class="fas fa-water"></i> Météo Marine</h1>
            <div class="header-actions">
                <button class="icon-btn" onclick="refreshData()" title="Actualiser">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <button class="icon-btn" onclick="openSettings()" title="Paramètres">
                    <i class="fas fa-cog"></i>
                </button>
            </div>
        </header>

        <!-- Side Menu (avec ID pour l'installation) -->
        <nav id="sideMenu" class="side-menu">
            <div class="menu-header">
                <h3><i class="fas fa-map"></i> Zones</h3>
                <button onclick="toggleMenu()" class="close-menu">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="menu-items">
                <button class="menu-item active" data-location="nord" onclick="selectLocation('nord')">
                    <i class="fas fa-water"></i> Côte Nord
                </button>
                <button class="menu-item" data-location="sud" onclick="selectLocation('sud')">
                    <i class="fas fa-sun"></i> Côte Sud
                </button>
                <button class="menu-item" data-location="morlaix" onclick="selectLocation('morlaix')">
                    <i class="fas fa-anchor"></i> Baie de Morlaix
                </button>
                <button class="menu-item" data-location="brest" onclick="selectLocation('brest')">
                    <i class="fas fa-ship"></i> Rade de Brest
                </button>
                <button class="menu-item" data-location="quiberon" onclick="selectLocation('quiberon')">
                    <i class="fas fa-umbrella-beach"></i> Quiberon
                </button>
                <button class="menu-item" data-location="finistere" onclick="selectLocation('finistere')">
                    <i class="fas fa-mountain"></i> Finistère
                </button>
            </div>
            <div class="menu-footer">
                <!-- BOUTON INSTALLATION AVEC ID -->
                <button class="menu-item" id="installMenuButton" onclick="installFromMenu()" style="display: none;">
                    <i class="fas fa-download"></i> Installer l'app
                </button>
                <button class="menu-item" onclick="showAbout()">
                    <i class="fas fa-info-circle"></i> À propos
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- API Info / Configuration -->
            <div class="api-info" id="apiInfo">
                <p><i class="fas fa-key"></i> Configurez votre clé API Stormglass</p>
                <button onclick="openSettings()" class="config-btn">
                    <i class="fas fa-cog"></i> Configurer
                </button>
            </div>

            <!-- Current Weather Card -->
            <div class="weather-card">
                <div class="location-header">
                    <h2 id="locationName">Côte Nord Bretagne</h2>
                    <div class="status">
                        <span id="connectionStatus" class="online">
                            <i class="fas fa-circle"></i> En ligne
                        </span>
                        <span id="lastUpdate" class="update-time">Mis à jour: --:--</span>
                    </div>
                </div>

                <div class="weather-main">
                    <div class="temp-section">
                        <div class="current-temp" id="currentTemp">--°C</div>
                        <div class="conditions" id="conditions">Chargement...</div>
                        <div class="sea-temp" id="seaTemp">Mer: --°C</div>
                    </div>
                    <div class="weather-icon" id="weatherIcon">
                        <i class="fas fa-cloud-sun"></i>
                    </div>
                </div>

                <div class="weather-details">
                    <div class="detail-card">
                        <div class="detail-icon"><i class="fas fa-wind"></i></div>
                        <div class="detail-info">
                            <div class="detail-label">Vent</div>
                            <div class="detail-value" id="windValue">-- nœuds</div>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon"><i class="fas fa-water"></i></div>
                        <div class="detail-info">
                            <div class="detail-label">Vagues</div>
                            <div class="detail-value" id="waveValue">-- m</div>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon"><i class="fas fa-tachometer-alt"></i></div>
                        <div class="detail-info">
                            <div class="detail-label">Pression</div>
                            <div class="detail-value" id="pressureValue">-- hPa</div>
                        </div>
                    </div>
                    <div class="detail-card">
                        <div class="detail-icon"><i class="fas fa-eye"></i></div>
                        <div class="detail-info">
                            <div class="detail-label">Visibilité</div>
                            <div class="detail-value" id="visibilityValue">-- km</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Warning Card -->
            <div class="warning-card" id="warningCard">
                <div class="warning-icon"><i class="fas fa-info-circle"></i></div>
                <div class="warning-content">
                    <div class="warning-title" id="warningTitle">Chargement</div>
                    <div class="warning-text" id="warningText">Connexion à l'API en cours...</div>
                </div>
            </div>

            <!-- Prévisions -->
            <div class="section-title">
                <h3><i class="fas fa-chart-line"></i> Prévisions 24h</h3>
            </div>
            <div class="forecast-container" id="forecastContainer">
                <div class="forecast-loading">
                    <div class="spinner"></div>
                    <p>Chargement des prévisions...</p>
                </div>
            </div>

            <!-- ========================================= -->
            <!-- CARTE INTERACTIVE - VERSION CORRIGÉE      -->
            <!-- ========================================= -->
            <div class="section-title">
                <h3><i class="fas fa-map-marked-alt"></i> Carte des conditions marines</h3>
                <span class="badge">Bretagne - 6 zones</span>
            </div>

            <div class="map-full-container">
                <!-- Légende -->
                <div class="map-legend-card">
                    <h4><i class="fas fa-info-circle"></i> Conditions actuelles</h4>
                    <div class="legend-items">
                        <div class="legend-item"><span class="dot" style="background: #4CAF50;"></span> Calme (vent < 10 nd)</div>
                        <div class="legend-item"><span class="dot" style="background: #FFC107;"></span> Modéré (10-20 nd)</div>
                        <div class="legend-item"><span class="dot" style="background: #FF9800;"></span> Agité (20-30 nd)</div>
                        <div class="legend-item"><span class="dot" style="background: #F44336;"></span> Danger (>30 nd)</div>
                    </div>
                    <div class="tide-info">
                        <i class="fas fa-clock"></i> 
                        <span id="mapUpdateTime">Mise à jour: --:--</span>
                    </div>
                </div>

                <!-- Carte SVG -->
                <div class="map-svg-container">
                    <svg viewBox="0 0 800 600" class="bretagne-map">
                        <!-- DÉFINITIONS (AJOUTÉES) -->
                        <defs>
                            <linearGradient id="gradNord" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#2196F3;stop-opacity:0.7" />
                                <stop offset="100%" style="stop-color:#4CAF50;stop-opacity:0.7" />
                            </linearGradient>
                            <linearGradient id="gradSud" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:0.7" />
                                <stop offset="100%" style="stop-color:#FFC107;stop-opacity:0.7" />
                            </linearGradient>
                            <linearGradient id="gradMorlaix" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#FF9800;stop-opacity:0.7" />
                                <stop offset="100%" style="stop-color:#F44336;stop-opacity:0.7" />
                            </linearGradient>
                            <linearGradient id="gradBrest" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#2196F3;stop-opacity:0.7" />
                                <stop offset="100%" style="stop-color:#FF9800;stop-opacity:0.7" />
                            </linearGradient>
                            <linearGradient id="gradQuiberon" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#4CAF50;stop-opacity:0.7" />
                                <stop offset="100%" style="stop-color:#2196F3;stop-opacity:0.7" />
                            </linearGradient>
                            <linearGradient id="gradFinistere" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" style="stop-color:#F44336;stop-opacity:0.7" />
                                <stop offset="100%" style="stop-color:#FF9800;stop-opacity:0.7" />
                            </linearGradient>
                        </defs>

                        <!-- Fond mer -->
                        <rect x="0" y="0" width="800" height="600" fill="#e6f3ff"/>

                        <!-- Contour Bretagne -->
                        <path d="M200,300 L300,200 L450,150 L600,200 L650,250 L600,350 L500,400 L350,450 L200,400 L150,350 L200,300" 
                              fill="#8BC34A" stroke="#2E7D32" stroke-width="3"/>

                        <!-- Villes -->
                        <circle cx="250" cy="320" r="6" fill="#FF5722" stroke="white" stroke-width="2"/>
                        <text x="230" y="300" class="city-label">Brest</text>
                        <circle cx="380" cy="250" r="6" fill="#FF5722" stroke="white" stroke-width="2"/>
                        <text x="360" y="230" class="city-label">Morlaix</text>
                        <circle cx="500" cy="280" r="6" fill="#FF5722" stroke="white" stroke-width="2"/>
                        <text x="480" y="260" class="city-label">St-Malo</text>
                        <circle cx="320" cy="400" r="6" fill="#FF5722" stroke="white" stroke-width="2"/>
                        <text x="300" y="380" class="city-label">Quimper</text>
                        <circle cx="550" cy="350" r="6" fill="#FF5722" stroke="white" stroke-width="2"/>
                        <text x="530" y="330" class="city-label">Vannes</text>
                        <circle cx="600" cy="400" r="6" fill="#FF5722" stroke="white" stroke-width="2"/>
                        <text x="580" y="380" class="city-label">Nantes</text>

                        <!-- Zones maritimes interactives -->
                        <g class="marine-zone" data-location="nord" onclick="selectLocationFromMap('nord')">
                            <ellipse cx="380" cy="180" rx="70" ry="40" fill="url(#gradNord)" opacity="0.7" class="zone-hover"/>
                            <text x="380" y="170" class="zone-label" text-anchor="middle">Côte Nord</text>
                            <text x="380" y="190" class="zone-temp" id="mapTempNord" text-anchor="middle">--°C</text>
                        </g>
                        <g class="marine-zone" data-location="sud" onclick="selectLocationFromMap('sud')">
                            <ellipse cx="550" cy="450" rx="70" ry="40" fill="url(#gradSud)" opacity="0.7" class="zone-hover"/>
                            <text x="550" y="440" class="zone-label" text-anchor="middle">Côte Sud</text>
                            <text x="550" y="460" class="zone-temp" id="mapTempSud" text-anchor="middle">--°C</text>
                        </g>
                        <g class="marine-zone" data-location="morlaix" onclick="selectLocationFromMap('morlaix')">
                            <ellipse cx="380" cy="220" rx="50" ry="30" fill="url(#gradMorlaix)" opacity="0.7" class="zone-hover"/>
                            <text x="380" y="210" class="zone-label" text-anchor="middle">Morlaix</text>
                            <text x="380" y="230" class="zone-temp" id="mapTempMorlaix" text-anchor="middle">--°C</text>
                        </g>
                        <g class="marine-zone" data-location="brest" onclick="selectLocationFromMap('brest')">
                            <ellipse cx="250" cy="350" rx="50" ry="30" fill="url(#gradBrest)" opacity="0.7" class="zone-hover"/>
                            <text x="250" y="340" class="zone-label" text-anchor="middle">Brest</text>
                            <text x="250" y="360" class="zone-temp" id="mapTempBrest" text-anchor="middle">--°C</text>
                        </g>
                        <g class="marine-zone" data-location="quiberon" onclick="selectLocationFromMap('quiberon')">
                            <ellipse cx="520" cy="400" rx="50" ry="30" fill="url(#gradQuiberon)" opacity="0.7" class="zone-hover"/>
                            <text x="520" y="390" class="zone-label" text-anchor="middle">Quiberon</text>
                            <text x="520" y="410" class="zone-temp" id="mapTempQuiberon" text-anchor="middle">--°C</text>
                        </g>
                        <g class="marine-zone" data-location="finistere" onclick="selectLocationFromMap('finistere')">
                            <ellipse cx="180" cy="300" rx="60" ry="35" fill="url(#gradFinistere)" opacity="0.7" class="zone-hover"/>
                            <text x="180" y="290" class="zone-label" text-anchor="middle">Finistère</text>
                            <text x="180" y="310" class="zone-temp" id="mapTempFinistere" text-anchor="middle">--°C</text>
                        </g>
                    </svg>
                </div>

                <!-- Carte zone sélectionnée -->
                <div class="selected-zone-card" id="selectedZoneCard">
                    <div class="selected-zone-header">
                        <i class="fas fa-location-dot"></i>
                        <h4 id="selectedZoneName">Côte Nord Bretagne</h4>
                    </div>
                    <div class="selected-zone-weather">
                        <div class="selected-temp"><span id="selectedZoneTemp">--°C</span><small>air</small></div>
                        <div class="selected-sea"><span id="selectedZoneSea">--°C</span><small>mer</small></div>
                        <div class="selected-wind"><i class="fas fa-wind"></i> <span id="selectedZoneWind">-- nd</span></div>
                        <div class="selected-waves"><i class="fas fa-water"></i> <span id="selectedZoneWaves">-- m</span></div>
                    </div>
                    <button onclick="goToSelectedZone()" class="zone-action-btn">
                        <i class="fas fa-arrow-right"></i> Voir détails
                    </button>
                </div>

                <!-- Échelle -->
                <div class="map-scale">
                    <div class="scale-bar"></div>
                    <span>50 km</span>
                </div>
            </div>
            <!-- FIN CARTE -->

        </main>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
            <button class="nav-btn active" onclick="switchTab('weather')">
                <i class="fas fa-cloud-sun"></i>
                <span>Météo</span>
            </button>
            <button class="nav-btn" onclick="switchTab('forecast')">
                <i class="fas fa-chart-line"></i>
                <span>Prévisions</span>
            </button>
            <button class="nav-btn" onclick="switchTab('alerts')">
                <i class="fas fa-bell"></i>
                <span>Alertes</span>
            </button>
            <button class="nav-btn" onclick="switchTab('info')">
                <i class="fas fa-info-circle"></i>
                <span>Infos</span>
            </button>
        </div>
    </div>

    <!-- ========================================= -->
    <!-- MODALS                                   -->
    <!-- ========================================= -->

    <!-- Settings Modal (avec champ API Key) -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Paramètres</h3>
                <button onclick="closeModal()" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <!-- GROUPE API KEY -->
                <div class="setting-group">
                    <h4><i class="fas fa-key"></i> API Stormglass</h4>
                    <div class="input-group">
                        <input type="password" id="apiKeyInput" placeholder="Votre clé API">
                        <button onclick="saveApiKey()" class="btn-save">
                            <i class="fas fa-save"></i> Sauvegarder
                        </button>
                    </div>
                    <p class="help-text">
                        <a href="https://stormglass.io" target="_blank">
                            <i class="fas fa-external-link-alt"></i> Obtenir une clé gratuite
                        </a>
                    </p>
                </div>

                <!-- Autres réglages (mode sombre, unités, etc.) -->
                <div class="setting-group">
                    <h4><i class="fas fa-sliders-h"></i> Préférences</h4>
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="darkModeToggle">
                            <span class="slider"></span>
                        </label>
                        <span>Mode sombre</span>
                    </div>
                    <div class="setting-item">
                        <label class="switch">
                            <input type="checkbox" id="notificationsToggle">
                            <span class="slider"></span>
                        </label>
                        <span>Notifications</span>
                    </div>
                    <select id="unitsSelect" class="select-box">
                        <option value="metric">Métrique (°C, nœuds, m)</option>
                        <option value="imperial">Impérial (°F, mph, ft)</option>
                    </select>
                </div>

                <div class="setting-group">
                    <h4><i class="fas fa-database"></i> Données</h4>
                    <button onclick="clearCache()" class="btn-action">
                        <i class="fas fa-trash"></i> Vider le cache
                    </button>
                    <button onclick="exportData()" class="btn-action">
                        <i class="fas fa-download"></i> Exporter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> À propos</h3>
                <button onclick="closeModal()" class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="about-header">
                    <i class="fas fa-water fa-3x"></i>
                    <h2>Météo Marine Bretagne</h2>
                </div>
                <div class="about-info">
                    <p><strong>Version:</strong> 1.0.0 PWA</p>
                    <p><strong>Dernière mise à jour:</strong> <span id="versionDate">2026</span></p>
                    <p><strong>Source données:</strong> Stormglass API</p>
                </div>
                <div class="about-features">
                    <h4><i class="fas fa-star"></i> Fonctionnalités</h4>
                    <ul>
                        <li><i class="fas fa-check"></i> Données temps réel</li>
                        <li><i class="fas fa-check"></i> 6 zones côtières</li>
                        <li><i class="fas fa-check"></i> Prévisions 24h</li>
                        <li><i class="fas fa-check"></i> Mode hors ligne</li>
                        <li><i class="fas fa-check"></i> Installation PWA</li>
                    </ul>
                </div>
                <div class="about-footer">
                    <p>Développé avec ❤️ pour les marins bretons</p>
                    <p><a href="https://github.com/David44-meteo/meteo-marine-bretagne" target="_blank">
                        <i class="fab fa-github"></i> Code source
                    </a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offlineIndicator" class="offline-indicator">
        <i class="fas fa-wifi-slash"></i>
        <span>Mode hors ligne - Données en cache</span>
    </div>

    <!-- Script principal -->
    <script src="app.js"></script>
    <!-- Script additionnel pour les fonctions de carte (déjà dans app.js mais on peut renforcer) -->
    <script>
        // Redéfinition locale pour être sûr que les IDs existent
        window.selectLocationFromMap = function(locationId) {
            if (window.selectLocation) {
                window.selectLocation(locationId);
                // Mise à jour carte
                document.querySelectorAll('.marine-zone').forEach(z => z.classList.remove('active'));
                document.querySelector(`.marine-zone[data-location="${locationId}"]`)?.classList.add('active');
                // Mise à jour carte sélectionnée
                if (window.updateSelectedZoneCard) window.updateSelectedZoneCard(locationId);
            }
        };

        window.goToSelectedZone = function() {
            document.querySelector('.weather-card').scrollIntoView({ behavior: 'smooth' });
        };

        // Initialisation carte
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                // Simuler affichage températures sur carte (sera écrasé par app.js)
                document.querySelectorAll('.zone-temp').forEach(el => {
                    if (!el.textContent || el.textContent === '--°C') el.textContent = '15°C';
                });
            }, 500);
        });
    </script>
</body>
</html>
